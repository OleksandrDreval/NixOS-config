# NixOS Безпечна Конфігурація v4.2 ![NixOS](https://img.shields.io/badge/NixOS-24.11-blue.svg) [![Security Level](https://img.shields.io/badge/SECURITY-Paranoic-red)](https://nixos.org/security)

**Декларативна система, орієнтована на забезпечення кібербезпеки та апаратної ізоляції**  
*Остання ревізія: 09/02/2025*

---

## Структура конфігураційного файлу `configuration.nix`

### Модульна архітектура
```nix
{
  boot = { ... };         # Налаштування завантаження та ядра
  networking = { ... };   # Мережева конфігурація та фаєрвол
  services = { ... };     # Системні сервіси та демони
  security = { ... };     # Політики безпеки та захист
  virtualisation = { ... }; # Віртуалізація та контейнери
  # ...інші модулі, що будуть додані у майбутньому
}
```
Кожен модуль містить атомарні налаштування з чітко визначеною зоною відповідальності. Зміни здійснюються виключно через конфігураційний файл, що гарантує єдине джерело істини.

---

## Деталізація системних параметрів

### 1. Завантажувальне середовище (boot)
Цей модуль визначає налаштування, пов'язані з процесом завантаження та ядром системи.  Він містить кілька важливих підрозділів, які детально розглянуті нижче.

### `boot.loader`

Цей підрозділ налаштовує завантажувач systemd-boot.

*   `enable = true`: Активує systemd-boot як основний завантажувач системи.
*   `consoleMode = "max"`: Встановлює максимальну роздільну здатність для консолі під час завантаження.
*   `configurationLimit = 5`: Обмежує кількість збережених конфігурацій завантаження до 5, видаляючи старіші.
*   `editor = false`: Деактивує вбудований редактор конфігурації в меню завантаження, запобігаючи несанкціонованим змінам.
*   `timeout = 10`: Встановлює час очікування вибору опції завантаження в меню (10 секунд).

### `boot.kernelParams`

Цей підрозділ визначає параметри, що передаються ядру під час завантаження.  Ці параметри суттєво впливають на безпеку та продуктивність системи.  Деякі ключові параметри та їх вплив на безпеку:

*   `iommu=force`: Примусово активує IOMMU (Input/Output Memory Management Unit). IOMMU ізолює пристрої вводу/виводу, запобігаючи несанкціонованому доступу до пам'яті.
*   `iommu.passthrough=0`: Деактивує режим passthrough для IOMMU, що забезпечує додаткові перевірки доступу до пам'яті пристроями.
*   `iommu.strict=1`: Активує строгий режим IOMMU, посилюючи контроль над доступом пристроїв до системної пам'яті.
*   `kernel.printk="3 4 1 3"`: Налаштовує рівень деталізації повідомлень ядра, обмежуючи обсяг виводу для зменшення потенційної витоку інформації.
*   `l1tf=full,force`:  Забезпечує повний захист від уразливості L1 Terminal Fault (L1TF), яка дозволяє зловмисникам отримати доступ до даних з кешу L1.
*   `lockdown=confidentiality:integrity`: Активує режим блокування ядра, обмежуючи можливості зміни критичних параметрів, що сприяє збереженню конфіденційності та цілісності системи.
*   `loglevel=0`: Встановлює мінімальний рівень логування ядра, зменшуючи кількість детальної інформації, доступної потенційним зловмисникам.
*   `mds=full,nosmt`:  Захищає від уразливості Microarchitectural Data Sampling (MDS), запобігаючи витоку даних між потоками, відключаючи Simultaneous Multithreading (SMT).
*   `mitigations=auto,nosmt`: Автоматично застосовує патчі для відомих уразливостей, також відключаючи SMT для підвищення безпеки.
*   `module.sig_enforce=1`:  Вимагає цифрового підпису для всіх модулів ядра, гарантуючи, що завантажуються лише авторизовані та перевірені модулі.
*   `oops=panic`:  Встановлює режим "panic" при виникненні критичної помилки ядра (oops), запобігаючи подальшій роботі системи у потенційно небезпечному стані.
*   `page_alloc.shuffle=1`:  Рандомізує розподіл сторінок пам'яті, ускладнюючи експлоїти, що залежать від передбачуваного розташування даних.
*   `page_poison=1`:  Заповнює звільнену пам'ять спеціальними значеннями, запобігаючи можливості відновити конфіденційні дані.
*   `pti=on`:  Активує Page Table Isolation (PTI), що ізолює таблиці сторінок ядра для захисту від атак, заснованих на витоку інформації через таблиці сторінок.
*   `quiet`: Зменшує кількість повідомлень, що виводяться під час завантаження, забезпечуючи чистіший вивід на консоль.

### `boot.kernel.sysctl`

Цей підрозділ налаштовує параметри ядра sysctl, які керують поведінкою системи після завантаження.  Він містить багато налаштувань, спрямованих на підвищення безпеки, таких як захист файлової системи, обмеження мережевих функцій та запобігання витоку інформації.

### `boot.blacklistedKernelModules`

Цей підрозділ містить список модулів ядра, завантаження яких заборонено.  Це допомагає зменшити поверхню атаки, виключаючи модулі, що можуть бути використані зловмисниками.

### `boot.cleanTmpDir` та `boot.tmpOnTmpfs`

Ці налаштування забезпечують очищення тимчасової директорії `/tmp` при кожному запуску системи та використання tmpfs для `/tmp`, що підвищує безпеку та конфіденційність, видаляючи тимчасові файли та запобігаючи їх збереженню на диску.
---

### 3. Мережа (networking)
```nix
networking = {
  firewall = {
    enable = true;
    allowedTCPPorts = [ 53 67 68 80 443 8080 ];
    allowedUDPPorts = [ 53 67 68 80 443 ];
    logRefusedConnections = true;
    allowPing = false;
    logIPv6Drops = true;
  };
};
```

#### Стратегія фаєрвола
- Політика за замовчуванням: DROP для вхідного трафіку та ACCEPT для вихідного.
- Визначено: 
  - TCP-порти – 53, 80, 123, 443, 8080, 8443, 5353.
  - UDP-порти – 53, 67, 68, 123, 5353.
- Захист від DDoS:
  - Налаштування `net.ipv4.tcp_syncookies=1`.
  - Обмеження з'єднань за допомогою `iptables -m connlimit`.

#### Логування та моніторинг
- Інтеграція з Fail2Ban для виявлення вторгнень.
- Регулярний аудит трафіку за допомогою nmap.
- VPN-інтеграція з використанням WireGuard з постквантовими алгоритмами.

---

### 4. Віртуалізація та ізоляція (virtualisation)
```nix
virtualisation = {
  libvirtd = {
    enable = true;
    extraConfig = ''...'';
  };
  spiceUSBRedirection.enable = true;
};
```

#### SELinux політики для libvirt
```nix
security_driver = "selinux"
seccomp_sandbox = 1
security_default_confined = 1
```
- Модель доступу: RBAC (Role-Based Access Control).
- Встановлено SELinux контексти:
  - `system_u:system_r:svirt_t:s0` для віртуальних машин.
  - `system_u:object_r:svirt_image_t:s0` для образів.

#### Захист від VM Escape
- Обмеження ресурсів за допомогою cgroups v2.
- Апаратна ізоляція через Intel VT-d/AMD-Vi.
- Відключення Kernel Samepage Merging (KSM) для запобігання витокам пам’яті.

## Додаткові ресурси
1. [NixOS Hardening Guide](https://nixos.wiki/wiki/Hardening)
2. [Linux Kernel Security Parameters](https://kernsec.org/wiki/index.php/Kernel_Self_Protection_Project)
3. [Virtualization Security Best Practices](https://libvirt.org/docs.html)
4. [LUKS2 Encryption Deep Dive](https://gitlab.com/cryptsetup/cryptsetup/-/wikis/FrequentlyAskedQuestions)
5. [Awesome Security Hardening Resources](https://github.com/decalage2/awesome-security-hardening)
6. [Linux Server Security Guide](https://github.com/imthenachoman/How-To-Secure-A-Linux-Server)
7. [NixOS Installation & Configuration](https://github.com/titanknis/Nixos-Installation-Guide)
8. [NixOps Virtualization Guide](https://nixos.wiki/wiki/NixOps/Virtualization)
9. [NixOS Configuration Explained](https://christitus.com/nixos-explained/)
