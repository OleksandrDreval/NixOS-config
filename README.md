# NixOS –ë–µ–∑–ø–µ—á–Ω–∞ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è ![NixOS](https://img.shields.io/badge/NixOS-24.11-blue.svg)

**–î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∑ —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –±–µ–∑–ø–µ–∫—É.**  
*–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: 01/02/2025*

---

## üîê –ö–ª—é—á–æ–≤—ñ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –±–µ–∑–ø–µ–∫–∏

### 1. –ó–∞—Ö–∏—Å—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞

```nix
boot.initrd.luks.devices."luks-911765a7-6ecb-4c99-88ef-b44c26fd3583".device = "/dev/disk/by-uuid/911765a7-6ecb-4c99-88ef-b44c26fd3583";
boot.initrd.systemd.enable = true; # –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è systemd-initrd
boot.loader.efi.canTouchEfiVariables = false; # –ó–∞–±–æ—Ä–æ–Ω–∞ –∑–º—ñ–Ω–∏ EFI –∑–º—ñ–Ω–Ω–∏—Ö
```

- **LUKS2** —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–∏—Å–∫–∞ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º UUID –¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Ä–æ–∑–¥—ñ–ª—É.
- `systemd-initrd` –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Ç–∞ –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.
- –ó–∞–±–æ—Ä–æ–Ω–∞ –∑–º—ñ–Ω–∏ EFI –∑–º—ñ–Ω–Ω–∏—Ö –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω–∏–º –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è–º.
- Secure Boot —á–µ—Ä–µ–∑ –ø–∞–∫–µ—Ç `sbctl` –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —à–∫—ñ–¥–ª–∏–≤–æ–≥–æ –∫–æ–¥—É.


### 2. –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —è–¥—Ä–∞ Linux

```nix
boot.kernelParams = [
  "kernel.printk=\"3 4 1 3\"" # –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–∏–≤–æ–¥—É —è–¥—Ä–∞
  "slab_nomerge" # –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ heap –µ–∫—Å–ø–ª–æ—ó—Ç—ñ–≤
  "page_poison=1" # –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∑–≤—ñ–ª—å–Ω–µ–Ω–æ—ó –ø–∞–º'—è—Ç—ñ
  "l1tf=full,force" # –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ L1 Terminal Fault
  "mds=full,nosmt" # –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ Microarchitectural Data Sampling
  "spectre_v2=on" # –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ Spectre v2
  "spec_store_bypass_disable=on" # –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ Spectre Variant 4: Speculative Store Bypass
  "stf_barrier=on" # –ë–∞—Ä'—î—Ä –¥–ª—è Spectre Variant 4
  "module.sig_enforce=1" # –ü—Ä–∏–º—É—Å–æ–≤–µ –ø—ñ–¥–ø–∏—Å—É–≤–∞–Ω–Ω—è –º–æ–¥—É–ª—ñ–≤ —è–¥—Ä–∞
  "randomize_kstack_offset=on" # –†–∞–Ω–¥–æ–º—ñ–∑–∞—Ü—ñ—è –∑–º—ñ—â–µ–Ω–Ω—è —Å—Ç–µ–∫—É —è–¥—Ä–∞
  "pti=on" # Page Table Isolation
  "vsyscall=none" # –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è vsyscall
  "debugfs=off" # –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è debugfs
  "lockdown=confidentiality" # –†–µ–∂–∏–º –±–ª–æ–∫—É–≤–∞–Ω–Ω—è —è–¥—Ä–∞
  "usercopy=strict" # –°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑/–¥–æ –ø—Ä–æ—Å—Ç–æ—Ä—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
];
```

- –†–æ–∑—à–∏—Ä–µ–Ω–∏–π –Ω–∞–±—ñ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ —è–¥—Ä–∞ –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ —Ä—ñ–∑–Ω–∏—Ö —Ç–∏–ø—ñ–≤ –∞—Ç–∞–∫, –≤–∫–ª—é—á–∞—é—á–∏ Spectre, Meltdown, —Ç–∞ —ñ–Ω—à—ñ.
-  `lockdown=confidentiality` –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É –¥–æ —è–¥—Ä–∞.
-  `module.sig_enforce=1` –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ –º–æ–¥—É–ª—ñ —è–¥—Ä–∞.


### 3. –ú–µ—Ä–µ–∂–µ–≤–∞ –±–µ–∑–ø–µ–∫–∞

```nix
networking.firewall.enable = true;
networking.firewall.allowedTCPPorts = [ 53 80 123 443 8080 8443 5353 ];
networking.firewall.allowedUDPPorts = [ 53 67 68 123 5353 ];
networking.firewall.logRefusedConnections = true; # –õ–æ–≥—É–≤–∞–Ω–Ω—è –≤—ñ–¥—Ö–∏–ª–µ–Ω–∏—Ö –∑'—î–¥–Ω–∞–Ω—å
networking.firewall.allowPing = false; # –ó–∞–±–æ—Ä–æ–Ω–∞ ping
networking.firewall.logIPv6Drops = true; # –õ–æ–≥—É–≤–∞–Ω–Ω—è –≤—ñ–¥–∫–∏–Ω—É—Ç–∏—Ö IPv6 –ø–∞–∫–µ—Ç—ñ–≤
# –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–∞–≤–∏–ª–∞ iptables –¥–ª—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥–æ–∑—Ä—ñ–ª–∏—Ö –ø–∞–∫–µ—Ç—ñ–≤
networking.firewall.extraCommands = ''
  ...
'';
```

- Stateful firewall –∑ –æ–±–º–µ–∂–µ–Ω–∏–º –Ω–∞–±–æ—Ä–æ–º –¥–æ–∑–≤–æ–ª–µ–Ω–∏—Ö –ø–æ—Ä—Ç—ñ–≤.
-  `logRefusedConnections` –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —Å–ø—Ä–æ–± –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É.
-  `allowPing = false` –¥–ª—è –∑–º–µ–Ω—à–µ–Ω–Ω—è –≤–∏–¥–∏–º–æ—Å—Ç—ñ —Å–∏—Å—Ç–µ–º–∏ –≤ –º–µ—Ä–µ–∂—ñ.
-  –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–∞–≤–∏–ª–∞ `iptables` –¥–ª—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥–æ–∑—Ä—ñ–ª–∏—Ö TCP-—Ñ–ª–∞–≥—ñ–≤ —Ç–∞ —ñ–Ω—à–∏—Ö –∞–Ω–æ–º–∞–ª—ñ–π.


### 4. –°–∏—Å—Ç–µ–º–Ω–∏–π –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥

```nix
services.journald.extraConfig = ''
  Storage=persistent # –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∂—É—Ä–Ω–∞–ª—ñ–≤ –Ω–∞ –¥–∏—Å–∫—É
  SystemMaxUse=500M # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä –∂—É—Ä–Ω–∞–ª—ñ–≤
  ForwardToSyslog=yes # –ü–µ—Ä–µ—Å–∏–ª–∞–Ω–Ω—è –∂—É—Ä–Ω–∞–ª—ñ–≤ –¥–æ syslog
  Compress=yes # –°—Ç–∏—Å–Ω–µ–Ω–Ω—è –∂—É—Ä–Ω–∞–ª—ñ–≤
  Seal=yes # –ü—ñ–¥–ø–∏—Å –∂—É—Ä–Ω–∞–ª—ñ–≤
  Audit=yes # –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ auditd
  ...
'';

security.auditd.enable = true;
security.audit.enable = true;
security.audit.rules = [
  "-a always,exit -F arch=b64 -S execve -k process_execution" # –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∑–∞–ø—É—Å–∫—É –ø—Ä–æ–≥—Ä–∞–º
  "-a always,exit -F arch=b64 -S bind -k network_bind" # –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ä–µ–∂–µ–≤–∏—Ö –∑'—î–¥–Ω–∞–Ω—å (bind)
  "-a always,exit -F arch=b64 -S connect -k network_connect" # –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ä–µ–∂–µ–≤–∏—Ö –∑'—î–¥–Ω–∞–Ω—å (connect)
];
```

- `journald` –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –¥–ª—è –ø–æ—Å—Ç—ñ–π–Ω–æ–≥–æ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∂—É—Ä–Ω–∞–ª—ñ–≤, —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è —Ç–∞ –ø—ñ–¥–ø–∏—Å—É.
- –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ `auditd` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞—É–¥–∏—Ç—É —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –ø–æ–¥—ñ–π.
-  –ü—Ä–∞–≤–∏–ª–∞ `auditd` –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∑–∞–ø—É—Å–∫—É –ø—Ä–æ–≥—Ä–∞–º —Ç–∞ –º–µ—Ä–µ–∂–µ–≤–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ.


### 5. –í—ñ—Ä—Ç—É–∞–ª—ñ–∑–∞—Ü—ñ—è

```nix
virtualisation.libvirtd.enable = true;
virtualisation.libvirtd.extraConfig = ''
  security_driver = "selinux" # –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è SELinux
  seccomp_sandbox = 1 # –ü—ñ—Å–æ—á–Ω–∏—Ü—è seccomp
  ...
'';
```

- `libvirtd` –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º SELinux –¥–ª—è —ñ–∑–æ–ª—è—Ü—ñ—ó –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏—Ö –º–∞—à–∏–Ω.
- `seccomp` –ø—ñ—Å–æ—á–Ω–∏—Ü—è –¥–ª—è –æ–±–º–µ–∂–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –≤–∏–∫–ª–∏–∫—ñ–≤ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏—Ö –º–∞—à–∏–Ω.
-  –î–æ–¥–∞—Ç–∫–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ `libvirtd` –¥–ª—è –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É –¥–æ —Ä–µ—Å—É—Ä—Å—ñ–≤ —Å–∏—Å—Ç–µ–º–∏.

---

## üìä –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑–ø–µ–∫–∏
